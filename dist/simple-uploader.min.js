/* simple-uploader v0.0.1 | (c) Mycolorway Design | MIT License */
(function(){var e,t,n,r,o,i=function(e,t){function n(){this.constructor=e}for(var r in t)u.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},u={}.hasOwnProperty;(o="object"==typeof module&&module.exports)?(e=require("simple-module"),n=require("lodash"),r=require("i18next")):(e=window.SimpleModule,n=window._,r=window.i18next),t=function(e){function t(e){t.__super__.constructor.call(this),n.extend(this.opts,t.opts,e),this.opts.lang&&t.changeLanguage(this.opts.lang),this.files=[],this.queue=[],this.id=++t.count,this._bind()}return i(t,e),t.count=0,t.opts={url:"",params:null,fileKey:"upload_file",connectionCount:3},t.i18n=r.init({lng:"en",fallbackLng:"en"}),t.prototype._bind=function(){return this.on("uploadcomplete",function(e){return function(t,n){return e.files.splice($.inArray(n,e.files),1),e.queue.length>0&&e.files.length<e.opts.connectionCount?e.upload(e.queue.shift()):0===e.files.length?(e.uploading=!1,e.triger("uploadstop")):void 0}}(this)),$(window).on("beforeunload.uploader-"+this.id,function(e){return function(t){return e.uploading?(t.originalEvent.returnValue=e._t("leaveConfirm"),e._t("leaveConfirm")):void 0}}(this))},t.prototype.generateId=function(){var e;return e=0,function(){return e+=1}}(),t.prototype.upload=function(e,t){var n,r,o,i;if(null==t&&(t={}),null!=e){if($.isArray(e)||e instanceof FileList)for(r=0,i=e.length;i>r;r++)n=e[r],this.upload(n,t);else $(e).is("input:file")?(o=$(e).attr("name"),o&&(t.fileKey=o),this.upload($.makeArray($(e)[0].files),t)):e.id&&e.obj||(e=this.getFile(e));if(e&&e.obj){if($.extend(e,t),this.files.length>=this.opts.connectionCount)return void this.queue.push(e);if(this.triggerHandler("beforeupload",[e])!==!1)return this.files.push(e),this._xhrUpload(e),this.uploading=!0}}},t.prototype.getFile=function(e){var t,n,r;return e instanceof window.File||e instanceof window.Blob?(t=null!=(n=e.fileName)?n:e.name,{id:this.generateId(),url:this.opts.url,params:this.opts.params,fileKey:this.opts.fileKey,name:t,size:null!=(r=e.fileSize)?r:e.size,ext:t?t.split(".").pop().toLowerCase():"",obj:e}):null},t.prototype._xhrUpload=function(e){var t,n,r,o;if(t=new FormData,t.append(e.fileKey,e.obj),t.append("original_filename",e.name),e.params){r=e.params;for(n in r)o=r[n],t.append(n,o)}return e.xhr=$.ajax({url:e.url,data:t,processData:!1,contentType:!1,type:"POST",headers:{"X-File-Name":encodeURIComponent(e.name)},xhr:function(){var e;return e=$.ajaxSettings.xhr(),e&&(e.upload.onprogress=function(e){return function(t){return e.progress(t)}}(this)),e},progress:function(t){return function(n){return n.lengthComputable?t.trigger("uploadprogress",[e,n.loaded,n.total]):void 0}}(this),error:function(t){return function(n,r,o){return t.trigger("uploaderror",[e,n,r])}}(this),success:function(t){return function(n){return t.trigger("uploadprogress",[e,e.size,e.size]),t.trigger("uploadsuccess",[e,n]),$(document).trigger("uploadsuccess",[e,n,t])}}(this),complete:function(t){return function(n,r){return t.trigger("uploadcomplete",[e,n.responseText])}}(this)})},t.prototype.cancel=function(e){var t,n,r,o;if(!e.id)for(o=this.files,n=0,r=o.length;r>n;n++)if(t=o[n],t.id===1*e){e=t;break}return this.trigger("uploadcancel",[e]),e.xhr&&e.xhr.abort(),e.xhr=null},t.prototype.readImageFile=function(e,t){var n,r;if($.isFunction(t))return r=new Image,r.onload=function(){return t(r)},r.onerror=function(){return t()},window.FileReader&&FileReader.prototype.readAsDataURL&&/^image/.test(e.type)?(n=new FileReader,n.onload=function(e){return r.src=e.target.result},n.readAsDataURL(e)):t()},t.prototype.destroy=function(){var e,t,n,r;for(this.queue.length=0,r=this.files,t=0,n=r.length;n>t;t++)e=r[t],this.cancel(e);return $(window).off(".uploader-"+this.id),$(document).off(".uploader-"+this.id)},t}(e),o?(require("i18n/en"),module.exports=t):window.SimpleUploader=t}).call(this);